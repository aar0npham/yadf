#!/usr/bin/env zsh

{{- if .personal }}
# Another way to profile zsh startup
PROFILE_STARTUP=false
if [[ $PROFILE_STARTUP == true ]]; then
    zmodload zsh/datetime
    PS4='+$EPOCHREALTIME %N:%i> '
    logfile=$(mkdir -p $ZDATADIR/logs && mktemp $ZDATADIR/logs/zsh_profile.XXXXXXXX)
    exec 3>&2 2>>$logfile
    setopt XTRACE
fi
{{- else if .transient }}
. $HOME/.local/bin/ssh-add
{{- end }}

source-safe() { if [ -f "$1" ]; then source "$1"; fi }

if [[ "$ZSHRC_PROFILE" != "" ]]; then
    zmodload zsh/zprof && zprof > /dev/null
fi

#--------------------------------------------------------------#
##          Base Configuration                                ##
#--------------------------------------------------------------#
source "$ZRCDIR/base.zsh"


#--------------------------------------------------------------#
##          Aliases                                           ##
#--------------------------------------------------------------#
source "$ZRCDIR/alias.zsh"


#--------------------------------------------------------------#
##          Options                                           ##
#--------------------------------------------------------------#
source "$ZRCDIR/options.zsh"


#--------------------------------------------------------------#
##          Completion                                        ##
#--------------------------------------------------------------#
source "$ZRCDIR/completion.zsh"


#--------------------------------------------------------------#
##          Prompt Configuration                              ##
#--------------------------------------------------------------#
if [[ "$ZSHRC_PROFILE" == "" ]]; then
    if [[ -z "$TIMESHELL" ]]; then
        if command -v virt-what &>/dev/null; then
            source "$ZRCDIR/prompt.zsh"
        else
            autoload -Uz promptinit
            promptinit
            prompt simple
        fi
    fi
fi


#--------------------------------------------------------------#
##          Key Bindings                                      ##
#--------------------------------------------------------------#
source "$ZRCDIR/bindkey.zsh"

if ! command -v virt-what &>/dev/null; then
    # functions
    source "$ZRCDIR/function.zsh"
    # plugins
    source "$ZRCDIR/plugins.zsh"
    # post
    source "$ZRCDIR/post.zsh"
fi

{{ if .personal }}
if [[ $PROFILE_STARTUP == true ]]; then
    unsetopt XTRACE
    exec 2>&3 3>&-
fi
{{- end }}
