#!/usr/bin/env sh

set -e

# get datetime
datetime=$(date +'%a %D %T %ZGMT')

cd $(chezmoi source-path)

echo "Dumping installed packages to files" >&2
{{- if eq .chezmoi.os "linux" }}
# Check for new packages, and add it to both .local file
PKGMN=yay
$PKGMN -Qqen >| {{ .chezmoi.sourceDir }}/bootstrap/configs/Pacfile.local && $PKGMN -Qqem >| {{ .chezmoi.sourceDir }}/bootstrap/configs/Aurfile.local
{{- else }}
brew bundle dump --file={{ .chezmoi.sourceDir }}/bootstrap/configs/Brewfile
{{- end }}

# Check if upstream, else not pull
if [ $(git rev-parse @)==$(git merge-base @ ${1:-'@{u}'}) ]; then
    git pull --recurse-submodules
fi

# execute scripts
git add -f -v . && git commit -am "$datetime: cron chores" && git push --all
# vim: set ft=zsh.gohtmltmpl ts=2 sw=2 tw=0 et :
