#!/usr/bin/env zsh

{{- $detailed := env "ZSH_DETAILED" | not | not }}
{{ if $detailed }}
# Another way to profile zsh startup
zmodload zsh/datetime
PS4='+$EPOCHREALTIME %N:%i> '
logfile=$(mkdir -p $HOME/log_zsh && mktemp log_zsh/zsh_profile.XXXXXXXX)
exec 3>&2 2>>$logfile
setopt XTRACE
{{ end }}

{{ if and (eq .chezmoi.os "linux") (.personal) }}
if [[ ! $DISPLAY && $XDG_VTNR -eq 1 ]]; then
    exec startx
fi
{{ end }}

# lazy loading some functions
for function in ${HOME}/.local/bin/*; do
    autoload -Uz ${function:t}
done

source-safe() { if [ -f "$1" ]; then source "$1"; fi }

#--------------------------------------------------------------#
##          Profile                                           ##
#--------------------------------------------------------------#

if [ "$ZSHRC_PROFILE" != "" ]; then
  zmodload zsh/zprof && zprof > /dev/null
fi

#--------------------------------------------------------------#
##          Base Configuration                                ##
#--------------------------------------------------------------#
source "$ZRCDIR/base.zsh"


#--------------------------------------------------------------#
##          Options                                           ##
#--------------------------------------------------------------#
source "$ZRCDIR/option.zsh"


#--------------------------------------------------------------#
##          Completion                                        ##
#--------------------------------------------------------------#
source "$ZRCDIR/completion.zsh"


#--------------------------------------------------------------#
##          Prompt Configuration                              ##
#--------------------------------------------------------------#
source "$ZRCDIR/prompt.zsh"


#--------------------------------------------------------------#
##          Function                                          ##
#--------------------------------------------------------------#
source "$ZRCDIR/function.zsh"


#--------------------------------------------------------------#
##          Aliases                                           ##
#--------------------------------------------------------------#
source "$ZRCDIR/alias.zsh"


#--------------------------------------------------------------#
##          Key Bindings                                      ##
#--------------------------------------------------------------#
source "$ZRCDIR/bindkey.zsh"

#source-safe "$ZHOMEDIR/zkbd/$TERM-${${DISPLAY:t}:-$VENDOR-$OSTYPE}"
#source "$ZHOMEDIR/zkbd/bindkey.zsh"


#--------------------------------------------------------------#
##          Plugin                                            ##
#--------------------------------------------------------------#
source "$ZRCDIR/plugins.zsh"


#--------------------------------------------------------------#
##          Post Execution                                    ##
#--------------------------------------------------------------#
source "$ZRCDIR/post.zsh"

source-safe "$ZDOTDIR/.zshrc.local"
source-safe "$ZHOMEDIR/.zshrc.local"

if [ -n "$ZSHRC_CI_TEST" ]; then
  echo "zshrc load complete"
  exit
fi

{{ if $detailed }}
unsetopt XTRACE
exec 2>&3 3>&-
{{ end }}
